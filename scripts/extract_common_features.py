import re
from typing import List


def extract_common_features(hex_list: List[str], placeholder: str = "??", remove_chars: str = "̲") -> str:
    def clean(s: str) -> List[str]:
        # 删除指定字符
        for ch in remove_chars:
            s = s.replace(ch, "")
        # 压缩空格，统一大写
        s = re.sub(r"\s+", " ", s.strip()).upper()
        return s.split()

    cleaned = [clean(s) for s in hex_list]

    # 确认长度一致
    length = len(cleaned[0])
    if not all(len(x) == length for x in cleaned):
        raise ValueError("输入的 hex 串长度不一致")

    # 每一列比对
    result = []
    for i in range(length):
        col = {row[i] for row in cleaned}
        result.append(col.pop() if len(col) == 1 else placeholder)

    return " ".join(result)


if __name__ == "__main__":
    # 示例
    # 气泡防撤回片段1原始串: 4.1.0.18/21/29
    hex_list_010000 = [
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 2B 3D 97 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲5̲5 ̲5̲6 ̲5̲7 ̲5̲3 ̲4̲8 ̲8̲1 ̲E̲C ̲6̲8 ̲0̲2 ̲0̲0 ̲0̲0 ̲4̲8 ̲8̲D ̲A̲C ̲2̲4 ̲8̲0 00 ̲0̲0 ̲0̲0 ̲4̲8 ̲C̲7 ̲8̲5 ̲E̲0 ̲0̲1 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 08 02 50 04 48 89 D9 48 89 F2 E8 CD 97 99 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 99 E9 63 FF B0 01 48 81 C4 68 02 00 00",
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 9B F6 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲5̲5 ̲5̲6 ̲5̲7 ̲5̲3 ̲4̲8 ̲8̲1 ̲E̲C ̲6̲8 ̲0̲2 ̲0̲0 ̲0̲0 ̲4̲8 ̲8̲D ̲A̲C ̲2̲4 ̲8̲0 00 ̲0̲0 ̲0̲0 ̲4̲8 ̲C̲7 ̲8̲5 ̲E̲0 ̲0̲1 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 38 B5 4F 04 48 89 D9 48 89 F2 E8 CD 3C 99 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 09 A3 63 FF B0 01 48 81 C4 68 02 00 00",
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 AB 11 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲5̲5 ̲5̲6 ̲5̲7 ̲5̲3 ̲4̲8 ̲8̲1 ̲E̲C ̲6̲8 ̲0̲2 ̲0̲0 ̲0̲0 ̲4̲8 ̲8̲D ̲A̲C ̲2̲4 ̲8̲0 ̲0̲0 ̲0̲0 ̲0̲0 ̲4̲8 ̲C̲7 ̲8̲5 ̲E̲0 ̲0̲1 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 48 93 55 04 48 89 D9 48 89 F2 E8 6D 1D 9A 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 A9 20 5E FF B0 01 48 81 C4 68 02 00 00"
    ]
    # 气泡防撤回片段1补丁串: 4.1.0.18/21/29
    hex_list_010001 = [
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 2B 3D 97 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲C̲3 ̲3̲D ̲1̲2 ̲2̲7 ̲0̲0 ̲0̲0 ̲0̲F ̲8̲4 ̲9̲9 ̲E̲B ̲F̲6 ̲0̲0 ̲E̲9 ̲E̲F ̲F̲2 ̲F̲6 00 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 08 02 50 04 48 89 D9 48 89 F2 E8 CD 97 99 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 99 E9 63 FF B0 01 48 81 C4 68 02 00 00",
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 9B F6 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲C̲3 ̲3̲D ̲1̲2 ̲2̲7 ̲0̲0 ̲0̲0 ̲0̲F ̲8̲4 ̲9̲9 ̲9̲0 ̲F̲6 ̲0̲0 ̲E̲9 ̲E̲F ̲9̲7 ̲F̲6 00 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 38 B5 4F 04 48 89 D9 48 89 F2 E8 CD 3C 99 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 09 A3 63 FF B0 01 48 81 C4 68 02 00 00",
        "48 89 54 24 10 55 41 57 41 56 41 55 41 54 56 57 53 48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 AB 11 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC ̲C̲3 ̲3̲D ̲1̲2 ̲2̲7 ̲0̲0 ̲0̲0 ̲0̲F ̲8̲4 ̲A̲E ̲0̲F ̲0̲4 ̲0̲1 ̲E̲9 ̲F̲F ̲1̲6 ̲0̲4 ̲0̲1 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 ̲9̲0 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2 AA E8 48 93 55 04 48 89 D9 48 89 F2 E8 6D 1D 9A 00 48 89 F9 48 89 DA E8 52 00 00 00 48 8D 4D A0 E8 A9 20 5E FF B0 01 48 81 C4 68 02 00 00"
    ]

    # 气泡防撤回片段1补丁串偏移1: 4.1.0.18/21/29
    hex_list_010001_offset00 = [
        "DF 02 48 8D 8D 08 01 00 00 48 8D 15 2D 87 ED 04 4C 8D 05 A8 7A ED 04 41 B9 E2 02 00 00 E8 59 2D E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 3B F9 E1 FD 48 8B 8D F0 02 00 00 4C 89 F2 E8 BC 74 FF FF 84 C0 0F 85 44 07 00 00 4C 8B BD 28 03 00 00 4C 3B BD 30 03 00 00 0F 84 6A 02 00 00 4C 89 F9 4C 89 F2",
        "DF 02 48 8D 8D 08 01 00 00 48 8D 15 8B 9B ED 04 4C 8D 05 06 8F ED 04 41 B9 E2 02 00 00 E8 E9 0B E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 CB D7 E1 FD 48 8B 8D F0 02 00 00 4C 89 F2 E8 BC 74 FF FF 84 C0 0F 85 44 07 00 00 4C 8B BD 28 03 00 00 4C 3B BD 30 03 00 00 0F 84 6A 02 00 00 4C 89 F9 4C 89 F2",
        "C1 E8 64 F2 D7 02 48 8D 8D B8 00 00 00 48 89 DA 4C 8D 05 90 44 E7 04 41 B9 BD 02 00 00 E8 94 96 CE FD 48 8D 8D B8 00 00 00 B2 01 E8 76 62 CE FD 48 8B 8D C0 02 00 00 4C 89 F2 E8 17 77 FF FF 84 C0 0F 85 3F 07 00 00 4C 8B BD F8 02 00 00 4C 3B BD 00 03 00 00 0F 84 61 02 00 00 4C 89 F9 4C 89 F2"
    ]

    # 气泡防撤回片段1补丁串偏移2: 4.1.0.18/21/29
    hex_list_010001_offset01 = [
        "01 00 00 B2 01 E8 06 F2 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 0B 67 00 00 4C 89 F1 E8 13 B3 DC FF 0F 1F 00 !48 8B 85 38 02 00 00 48 83 F8 10 49 BF CD CC CC CC CC CC CC CC 0F 82 AA F2 FF FF 48 8B 8D 20 02 00 00 48 8D 50 01 48 81 FA 00 10 00 00 0F 82 8D F2",
        "01 00 00 B2 01 E8 96 D0 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 0B 67 00 00 4C 89 F1 E8 13 B3 DC FF 0F 1F 00 !48 8B 85 38 02 00 00 48 83 F8 10 49 BF CD CC CC CC CC CC CC CC 0F 82 AA F2 FF FF 48 8B 8D 20 02 00 00 48 8D 50 01 48 81 FA 00 10 00 00 0F 82 8D F2",
        "48 8D 8D F0 02 00 00 48 8D 95 16 03 00 00 44 0F B6 85 17 03 00 00 E8 95 48 00 00 4C 89 F1 E8 2D E0 DB FF 66 66 66 66 2E 0F 1F 84 00 00 00 00 00 !48 8B 85 10 02 00 00 48 83 F8 10 49 BF CD CC CC CC CC CC CC CC 0F 82 C4 F2 FF FF 48 8B 8D F8 01 00 00 48 8D 50 01 48 81 FA 00 10 00 00 0F 82 A7 F2",
    ]

    # 气泡防撤回片段2原始串: 4.1.0.18/21/29
    hex_list_010100 = [
        "78 ED 04 41 B9 D9 02 00 00 E8 EC 2A E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 CE F6 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 D3 6B 00 00 4C 89 F2 E8 7B 6D 00 00 E9 ̲C̲6 ̲0̲4 ̲0̲0 ̲0̲0 48 8D 8D 20 03 00 00 4C 89 FA 4D 89 F0 E8 84 FA 00 00 E9 AF 04 00 00 48 01 D2 49 8B 0C D4 4C 8B B5 48 02 00 00 90 49 39 CB 0F 84 97 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 84 04 00 00 4D 39 D3 0F 84 7B 04 00 00 41 8B 4B 18 83 F9 05 77 61 B8 26 00 00 00 0F A3 C8",
        "8C ED 04 41 B9 D9 02 00 00 E8 7C 09 E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 5E D5 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 D3 6B 00 00 4C 89 F2 E8 7B 6D 00 00 E9 ̲C̲6 ̲0̲4 ̲0̲0 ̲0̲0 48 8D 8D 20 03 00 00 4C 89 FA 4D 89 F0 E8 84 FA 00 00 E9 AF 04 00 00 48 01 D2 49 8B 0C D4 4C 8B B5 48 02 00 00 90 49 39 CB 0F 84 97 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 84 04 00 00 4D 39 D3 0F 84 7B 04 00 00 41 8B 4B 18 83 F9 05 77 61 B8 26 00 00 00 0F A3 C8",
        "42 E7 04 41 B9 B4 02 00 00 E8 30 94 CE FD 48 8D 8D B8 00 00 00 B2 01 E8 12 60 CE FD 48 8D 8D F0 02 00 00 48 8D 95 16 03 00 00 44 0F B6 85 17 03 00 00 E8 57 4D 00 00 4C 89 F2 E8 FF 4E 00 00 E9 ̲C̲A ̲0̲4 ̲0̲0 ̲0̲0 48 8D 8D F0 02 00 00 4C 89 FA 4D 89 F0 E8 08 DC 00 00 E9 B3 04 00 00 48 01 D2 49 8B 0C D4 48 8D 1D 0E 4C E7 04 4C 8B B5 E8 02 00 00 66 66 66 66 66 2E 0F 1F 84 00 00 00 00 00 49 39 CB 0F 84 87 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 74 04 00 00 4D 39 D3 0F 84 6B"
    ]
    # 气泡防撤回片段2原始串: 4.1.0.18/21/29
    hex_list_010101 = [
        "78 ED 04 41 B9 D9 02 00 00 E8 EC 2A E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 CE F6 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 D3 6B 00 00 4C 89 F2 E8 7B 6D 00 00 E9 ̲C̲7 ̲1̲1 ̲0̲9 ̲F̲F 48 8D 8D 20 03 00 00 4C 89 FA 4D 89 F0 E8 84 FA 00 00 E9 AF 04 00 00 48 01 D2 49 8B 0C D4 4C 8B B5 48 02 00 00 90 49 39 CB 0F 84 97 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 84 04 00 00 4D 39 D3 0F 84 7B 04 00 00 41 8B 4B 18 83 F9 05 77 61 B8 26 00 00 00 0F A3 C8",
        "8C ED 04 41 B9 D9 02 00 00 E8 7C 09 E2 FD 48 8D 8D 08 01 00 00 B2 01 E8 5E D5 E1 FD 48 8D 8D 20 03 00 00 48 8D 95 46 03 00 00 44 0F B6 85 47 03 00 00 E8 D3 6B 00 00 4C 89 F2 E8 7B 6D 00 00 E9 ̲C̲7 ̲6̲C ̲0̲9 ̲F̲F 48 8D 8D 20 03 00 00 4C 89 FA 4D 89 F0 E8 84 FA 00 00 E9 AF 04 00 00 48 01 D2 49 8B 0C D4 4C 8B B5 48 02 00 00 90 49 39 CB 0F 84 97 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 84 04 00 00 4D 39 D3 0F 84 7B 04 00 00 41 8B 4B 18 83 F9 05 77 61 B8 26 00 00 00 0F A3 C8",
        "42 E7 04 41 B9 B4 02 00 00 E8 30 94 CE FD 48 8D 8D B8 00 00 00 B2 01 E8 12 60 CE FD 48 8D 8D F0 02 00 00 48 8D 95 16 03 00 00 44 0F B6 85 17 03 00 00 E8 57 4D 00 00 4C 89 F2 E8 FF 4E 00 00 E9 ̲B̲B ̲E̲D ̲F̲B ̲F̲E 48 8D 8D F0 02 00 00 4C 89 FA 4D 89 F0 E8 08 DC 00 00 E9 B3 04 00 00 48 01 D2 49 8B 0C D4 48 8D 1D 0E 4C E7 04 4C 8B B5 E8 02 00 00 66 66 66 66 66 2E 0F 1F 84 00 00 00 00 00 49 39 CB 0F 84 87 04 00 00 4D 8B 5B 08 49 3B 43 10 75 ED 4D 85 DB 0F 84 74 04 00 00 4D 39 D3 0F 84 6B"
    ]

    # 气泡防撤回片段2补丁串偏移1目标: 4.1.0.18/21/29
    hex_list_010101_offset00 = [
        "48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 2B 3D 97 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC C3 3D 12 27 00 00 0F 84 99 EB F6 00 E9 EF F2 F6 00 90 90 90 90 90 90 90 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2",
        "48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 9B F6 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC C3 3D 12 27 00 00 0F 84 99 90 F6 00 E9 EF 97 F6 00 90 90 90 90 90 90 90 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2",
        "48 83 EC 48 48 8D AA 80 00 00 00 48 8D 4D 60 E8 AB 11 96 FF 90 48 83 C4 48 5B 5F 5E 41 5C 41 5D 41 5E 41 5F 5D C3 CC CC CC CC CC CC CC CC CC C3 3D 12 27 00 00 0F 84 AE 0F 04 01 E9 FF 16 04 01 90 90 90 90 90 90 90 00 00 FE FF FF FF 48 89 D6 48 89 CF 48 8D 5D A0 41 B8 40 02 00 00 48 89 D9 B2"
    ]

    # 示例
    # print(extract_common_features(hex_list_010001_offset01))
